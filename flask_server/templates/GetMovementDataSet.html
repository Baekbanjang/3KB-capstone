<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Get Hand Gesture DataSet Test</title>

    <!-- 부트 스트랩 css-->
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.1/css/all.min.css" rel="stylesheet">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>

    <!-- 부트 스트랩 JS -->
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.bundle.min.js"></script>

    <style>
        .navbar-brand {
            margin: auto;
        }
        .mode-buttons {
            position: fixed; 
            top: 20px; 
            right: 20px;
            padding-top: 70px;
            font-weight: bold;
        }
        .fixedStreaming {
            position: fixed;
            top: 50%;
            left: 50%;
            width: 80%;
            transform: translate(-50%, -50%);
            z-index: 1000; /* 다른 요소들 위에 표시 */
            max-width: 640px;
            background-color: white; /* 배경색 설정, 필요에 따라 변경 가능 */
        }
    </style>
</head>

<body data-gesture-preset="{{ gesture_preset }}" data-pose-preset="{{ pose_preset }}">
    <nav class="navbar fixed-top navbar-light bg-light">
        <a class="navbar-brand" href="#">Gesture Sound</a>
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target=".navbar-collapse"
            aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
        <!-- 여기에 드롭다운 메뉴 추가 -->

        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav">
                <li class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle" href="#" id="navbarDropdownMenuLink" role="button"
                        data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                        메뉴
                    </a>
                    <div class="dropdown-menu" aria-labelledby="navbarDropdownMenuLink">
                        <a class="dropdown-item" href="/Movement_play">메인 화면</a>
                        <a class="dropdown-item" href="/Instrument_choice">악기소리 설정</a>
                        <a class="dropdown-item" href="/Get_AllMovements">모션 사용자 설정</a>
                        <a class="dropdown-item" href="/Playlist">영상 재생 목록</a>
                    </div>
                </li>
            </ul>
        </div>
    </nav>

    <!-- 여기에 버튼 추가 -->
    <div class="mode-buttons">
        <button id="GestureModeButton" class="btn btn-primary" value="gesture">제스처 모드</button>
        <button id="PoseModeButton" class="btn btn-secondary" value="pose">포즈 모드</button>
    </div>

    <!-- 프리셋 버튼 -->
    <div class="container mt-5">
        <h2>프리셋</h2>
        <button class="btn btn-primary PresetButton" value=1>1</button>
        <button class="btn btn-primary PresetButton" value=2>2</button>
        <button class="btn btn-primary PresetButton" value=3>3</button>
        <button class="btn btn-primary PresetButton" value=4>4</button>
        <button class="btn btn-secondary" id="resetButton">초기화</button>
    </div>

    <div class="container mt-3">
        <table class="table">
            <thead>
                <tr>
                    <th>계이름</th>
                    <th>포즈 설명</th>
                    <th>촬영</th>
                    <th>삭제</th>
                </tr>
            </thead>
            <tbody id="presetData">
                {% for data in pose_data %}
                <tr id="row_pose_{{ data.id }}">
                    <td>{{ data.name }}</td>
                    <td>
                        <span id="poseDescription{{ data.id }}">{{ data.description }}</span>
                        <input type="text" id="poseInput{{ data.id }}" style="display:none;">
                    </td>
                    <td>
                        <button class="LiveButton" value="{{ data.id }}">녹화하기</button>
                    </td>
                    <td>
                        <button class="DeleteButton" value="{{ data.id }}">삭제하기</button>
                    </td>
                    <td>
                        <button onclick="editPose({{ data.id }})">수정</button>
                        <button onclick="savePose({{ data.id }})" style="display:none;">저장</button>
                    </td>
                    <td>
                        <div id="myDiv{{ data.id }}" style="display: none;">
                            <img id="video_gesture{{ data.id }}" src="" /> <br>
                            <img id="video_pose{{ data.id }}" src=""/> <br>
                            <button class="stopButton" value="True">녹화 중지하기</button>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <script>
        var currentMode

        function editPose(id) {
            // 입력 필드와 저장 버튼을 보이게 합니다.
            document.getElementById('poseInput' + id).style.display = 'inline';
            document.getElementById('poseInput' + id).value = document.getElementById('poseDescription' + id).innerText;
            document.querySelector(`#row_pose_${id} button[onclick="savePose(${id})"]`).style.display = 'inline';

            // 기존 텍스트와 수정 버튼을 숨깁니다.
            document.getElementById('poseDescription' + id).style.display = 'none';
            document.querySelector(`#row_pose_${id} button[onclick="editPose(${id})"]`).style.display = 'none';
        }

        function savePose(id) {
            // 입력 필드에서 텍스트를 가져와서 span 요소에 설정합니다.
            var inputVal = document.getElementById('poseInput' + id).value;

            // URL-encoded 형식으로 데이터를 전송
            var formData = new URLSearchParams();
            formData.append('id', id);
            formData.append('mode', currentMode);
            formData.append('inputVal', inputVal);

            fetch('/save_pose', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: formData.toString()
            })
            .then(response => response.json())
            .then(data => {
                console.log('Success:', data);
            })
            .catch((error) => {
                console.error('Error:', error);
            });

            document.getElementById('poseDescription' + id).innerText = inputVal;

            // 텍스트와 수정 버튼을 다시 보이게 합니다.
            document.getElementById('poseDescription' + id).style.display = 'inline';
            document.querySelector(`#row_pose_${id} button[onclick="editPose(${id})"]`).style.display = 'inline';

            // 입력 필드와 저장 버튼을 숨깁니다.
            document.getElementById('poseInput' + id).style.display = 'none';
            document.querySelector(`#row_pose_${id} button[onclick="savePose(${id})"]`).style.display = 'none';
        }

        function updateButtonColors(preset) {
            const buttons = document.querySelectorAll('.PresetButton');
            buttons.forEach(button => {
                button.classList.remove('btn-success');
                button.classList.add('btn-primary');
            });
            const activeButton = document.querySelector('.PresetButton[value="' + preset + '"]');
            if (activeButton) {
                activeButton.classList.remove('btn-primary');
                activeButton.classList.add('btn-success');
            }
        }

        document.addEventListener('DOMContentLoaded', function () {
            const gestureModeButton = document.getElementById('GestureModeButton');
            const poseModeButton = document.getElementById('PoseModeButton');
            gesturePreset = document.body.getAttribute('data-gesture-preset');
            posePreset = document.body.getAttribute('data-pose-preset');
            currentMode = 'gesture'; // 기본 모드를 'gesture'로 설정

            gestureModeButton.addEventListener('click', function () {
                gestureModeButton.classList.add('btn-primary');
                gestureModeButton.classList.remove('btn-secondary');

                poseModeButton.classList.add('btn-secondary');
                poseModeButton.classList.remove('btn-primary');

                currentMode = 'gesture'; // 제스처 모드 선택 시
                updateButtonColors(gesturePreset);
                $.ajax({
                    url: "/Get_AllMovements",
                    type: "POST",
                    data: { mode: currentMode },
                    success: function (response) {
                        var tbody = $('#presetData');
                        tbody.empty(); // 기존 내용을 지우고
                        response.forEach(function(item) {
                            var row = `<tr id="row_pose_${item.id}">
                                <td>${item.name}</td>
                                <td>
                                    <span id="poseDescription${item.id}">${item.description}</span>
                                    <input type="text" id="poseInput${item.id}" style="display:none;">
                                </td>
                                <td>
                                    <button class="LiveButton" value="${item.id}">녹화하기</button>
                                </td>
                                <td>
                                    <button class="DeleteButton" value="${item.id}">삭제하기</button>
                                </td>
                                <td>
                                    <button onclick="editPose(${item.id})">수정</button>
                                    <button onclick="savePose(${item.id})" style="display:none;">저장</button>
                                </td>
                                <td>
                                    <div id="myDiv${item.id}" style="display: none;">
                                        <img id="video_gesture${item.id}" src="" /> <br>
                                        <img id="video_pose${item.id}" src=""/> <br>
                                        <button class="stopButton" value="True">녹화 중지하기</button>
                                    </div>
                                </td>
                            </tr>`;
                        tbody.append(row);
                    });
                        console.log("성공:", response);
                    },
                    error: function (error) {
                        console.log("오류:", error);
                    }
                });
            });

            poseModeButton.addEventListener('click', function () {
                poseModeButton.classList.add('btn-primary');
                poseModeButton.classList.remove('btn-secondary');

                gestureModeButton.classList.add('btn-secondary');
                gestureModeButton.classList.remove('btn-primary');

                currentMode = 'pose'; // 제스처 모드 선택 시
                updateButtonColors(posePreset);
                $.ajax({
                    url: "/Get_AllMovements",
                    type: "POST",
                    data: { mode: currentMode },
                    success: function (response) {
                        var tbody = $('#presetData');
                        tbody.empty(); // 기존 내용을 지우고
                        response.forEach(function(item) {
                            var row = `<tr id="row_pose_${item.id}">
                                <td>${item.name}</td>
                                <td>
                                    <span id="poseDescription${item.id}">${item.description}</span>
                                    <input type="text" id="poseInput${item.id}" style="display:none;">
                                </td>
                                <td>
                                    <button class="LiveButton" value="${item.id}">녹화하기</button>
                                </td>
                                <td>
                                    <button class="DeleteButton" value="${item.id}">삭제하기</button>
                                </td>
                                <td>
                                    <button onclick="editPose(${item.id})">수정</button>
                                    <button onclick="savePose(${item.id})" style="display:none;">저장</button>
                                </td>
                                <td>
                                    <div id="myDiv${item.id}" style="display: none;">
                                        <img id="video_gesture${item.id}" src="" /> <br>
                                        <img id="video_pose${item.id}" src=""/> <br>
                                        <button class="stopButton" value="True">녹화 중지하기</button>
                                    </div>
                                </td>
                            </tr>`;
                        tbody.append(row);
                    });
                        console.log("성공:", response);
                    },
                    error: function (error) {
                        console.log("오류:", error);
                    }
                });
            });

            document.querySelectorAll('.PresetButton').forEach(button => {
                if (button.value == gesturePreset) {
                    button.classList.remove('btn-primary');
                    button.classList.add('btn-success');
                }
            });
        });

        // Ajax를 사용하여 Flask로 데이터를 비동기적으로 전송하는 함수
        $(document).ready(function () {
            $('.PresetButton').each(function() {
                if ($(this).val() == gesturePreset) {
                    $(this).removeClass('btn-primary').addClass('btn-success');
                }
            });

            $('.PresetButton').click(function () {
                var buttonValue = $(this).val();
                console.log("버튼 값:", buttonValue);
                if (currentMode === 'gesture') {
                    gesturePreset = buttonValue;
                } else if (currentMode === 'pose') {
                    posePreset = buttonValue;
                }
                updateButtonColors(buttonValue);
                $('.PresetButton').removeClass('btn-success').addClass('btn-primary');
                $(this).removeClass('btn-primary').addClass('btn-success');
                $.ajax({
                    url: "/Get_AllMovements",
                    type: "POST",
                    data: { preset: buttonValue, mode: currentMode },
                    success: function (response) {
                        var tbody = $('#presetData');
                        tbody.empty(); // 기존 내용을 지우고
                        response.forEach(function(item) {
                            var row = `<tr id="row_pose_${item.id}">
                                <td>${item.name}</td>
                                <td>
                                    <span id="poseDescription${item.id}">${item.description}</span>
                                    <input type="text" id="poseInput${item.id}" style="display:none;">
                                </td>
                                <td>
                                    <button class="LiveButton" value="${item.id}">녹화하기</button>
                                </td>
                                <td>
                                    <button class="DeleteButton" value="${item.id}">삭제하기</button>
                                </td>
                                <td>
                                    <button onclick="editPose(${item.id})">수정</button>
                                    <button onclick="savePose(${item.id})" style="display:none;">저장</button>
                                </td>
                                <td>
                                    <div id="myDiv${item.id}" style="display: none;">
                                        <img id="video_gesture${item.id}" src="" /> <br>
                                        <img id="video_pose${item.id}" src=""/> <br>
                                        <button class="stopButton" value="True">녹화 중지하기</button>
                                    </div>
                                </td>
                            </tr>`;
                        tbody.append(row);
                    });
                        console.log("성공:", response);
                    },
                    error: function (error) {
                        console.log("오류:", error);
                    }
                });
            });

            $('#presetData').on('click', '.LiveButton', function () {
                var buttonValue = $(this).val();
                console.log("버튼 값:", buttonValue);
                $.ajax({
                    url: "/Get_AllMovements",
                    type: "POST",
                    data: { button_value: buttonValue, mode: currentMode },
                    success: function (response) {
                        console.log("성공:", response);
                        toggleDivVisibility(buttonValue);
                    },
                    error: function (error) {
                        console.log("오류:", error);
                    }
                });
            });

            $('#presetData').on('click', '.DeleteButton', function() {
                var buttonValue = $(this).val();
                $.ajax({
                    url: "/Get_AllMovements",
                    type: "POST",
                    data: { delete_button_value: buttonValue, mode: currentMode },
                    success: function (response) {
                        console.log("성공:", response);
                    },
                    error: function (error) {
                        console.log("오류:", error);
                    }
                });
            });
            
            $('#presetData').on('click', '.stopButton', function() {
                var stopSign = $(this).val();
                $.ajax({
                    url: "/Get_AllMovements",
                    type: "POST",
                    data: { stop_sign: stopSign, mode: currentMode },
                    success: function (response) {
                        console.log("성공:", response);
                        divClear();
                    },
                    error: function (error) {
                        console.log("오류:", error);
                    }
                });
            });

            $("#resetButton").click(function(){
                currentMode = "gesture";
                gesturePreset = '1';
                posePreset = '1';
                $('#GestureModeButton').addClass('btn-primary').removeClass('btn-secondary');
                $('#PoseModeButton').addClass('btn-secondary').removeClass('btn-primary');
                $.ajax({
                    url: "/reset",
                    type: "POST",
                    contentType: "application/json",
                    success: function (response) {
                        var tbody = $('#presetData');
                        tbody.empty(); // 기존 내용을 지우고
                        response.forEach(function(item) {
                            var row = `<tr id="row_pose_${item.id}">
                                <td>${item.name}</td>
                                <td>
                                    <span id="poseDescription${item.id}">${item.description}</span>
                                    <input type="text" id="poseInput${item.id}" style="display:none;">
                                </td>
                                <td>
                                    <button class="LiveButton" value="${item.id}">녹화하기</button>
                                </td>
                                <td>
                                    <button class="DeleteButton" value="${item.id}">삭제하기</button>
                                </td>
                                <td>
                                    <button onclick="editPose(${item.id})">수정</button>
                                    <button onclick="savePose(${item.id})" style="display:none;">저장</button>
                                </td>
                                <td>
                                    <div id="myDiv${item.id}" style="display: none;">
                                        <img id="video_gesture${item.id}" src="" /> <br>
                                        <img id="video_pose${item.id}" src=""/> <br>
                                        <button class="stopButton" value="True">녹화 중지하기</button>
                                    </div>
                                </td>
                            </tr>`;
                        tbody.append(row);
                    });
                        console.log(response);
                    },
                    error: function(xhr, status, error){
                        console.error("Error: ", status, error);
                    }
                });
            });
        });

        function toggleDivVisibility(buttonValue) {
            // 모든 버튼의 영상을 숨깁니다.
            $('[id^="video_gesture"], [id^="video_pose"]').attr('src', '');

            // 현재 클릭한 버튼에 해당하는 영상만 보여줍니다.
            //$('#video_gesture' + buttonValue).attr('src', "/get_video_gesture");
            // 현재 모드에 맞는 비디오 소스와 태그 선택
            var videoId = currentMode === "gesture" ? "#video_gesture" : "#video_pose";
            var videoSrc = currentMode === "gesture" ? "/get_video_gesture" : "/get_video_pose";
            $(videoId + buttonValue).attr('src', videoSrc).show();

            // 모든 버튼 영역을 숨깁니다.
            $('[id^="myDiv"]').hide().removeClass('fixedStreaming');

            // 현재 클릭한 버튼에 해당하는 영역만 보여줍니다.
            var showDiv=$('#myDiv' + buttonValue).show();
            showDiv.show().addClass('fixedStreaming')
        }

        function divClear() {
            // 모든 버튼의 영상을 숨깁니다.
            $('[id^="video_gesture"], [id^="video_pose"]').attr('src', '');
            

            // 모든 버튼 영역을 숨깁니다.
            $('[id^="myDiv"]').hide().removeClass('fixedStreaming');
        }
    </script>
</body>

</html>