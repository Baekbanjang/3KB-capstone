<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Get Hand Gesture DataSet Test</title>

    <!-- 부트스트랩 CSS -->
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.1/css/all.min.css" rel="stylesheet">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>

    <!-- 부트스트랩 JS -->
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.bundle.min.js"></script>

    <style>
        .navbar-brand {
            margin: auto;
        }
        .mode-buttons {
            position: fixed;
            top: 20px;
            right: 20px;
            padding-top: 70px;
            font-weight: bold;
        }
        .fixedStreaming {
            position: fixed;
            top: 50%;
            left: 50%;
            width: 80%;
            transform: translate(-50%, -50%);
            z-index: 1000; /* 다른 요소들 위에 표시 */
            max-width: 640px;
            background-color: white; /* 배경색 설정, 필요에 따라 변경 가능 */
        }
        .description-box {
            display: none; /* 처음에는 숨겨져 있음 */
            width: 720px; /* 박스의 너비 */
            border: 1px solid #000; /* 테두리 */
            padding: 10px; /* 내부 여백 */
            margin-top: 5px; /* 버튼과의 거리 */
            background-color: #f9f9f9; /* 배경색 */
            position: absolute; /* 절대 위치 */
        }

        .help-btn {
            padding: -2px 3px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            display: inline-block;
            vertical-align: middle;
        }
    </style>
</head>
<body data-gesture-preset="{{ gesture_preset }}" data-pose-preset="{{ pose_preset }}" current-mode="{{ mode }}">

    <nav class="navbar fixed-top navbar-light bg-light">
        <a class="navbar-brand" href="#">Gesture Sound</a>
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target=".navbar-collapse"
            aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
        <!-- 여기에 드롭다운 메뉴 추가 -->

        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav">
                <li class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle" href="#" id="navbarDropdownMenuLink" role="button"
                        data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                        메뉴
                    </a>
                    <div class="dropdown-menu" aria-labelledby="navbarDropdownMenuLink">
                        <a class="dropdown-item" href="/Movement_play">메인 화면</a>
                        <a class="dropdown-item" href="/Instrument_choice">악기소리 설정</a>
                        <a class="dropdown-item" href="/Get_AllMovements">모션 사용자 설정</a>
                        <a class="dropdown-item" href="/Playlist">영상 재생 목록</a>
                    </div>
                </li>
            </ul>
        </div>
    </nav>

    <!-- 여기에 버튼 추가 -->
    <div class="mode-buttons">
        <button id="GestureModeButton" class="btn btn-primary" value="gesture">손동작 모드</button>
        <button id="PoseModeButton" class="btn btn-secondary" value="pose">몸동작 모드</button>
    </div>

    <!-- 프리셋 버튼 -->
    <div class="container mt-5">
        <h2>프리셋</h2>
        <button class="btn btn-primary PresetButton" value=1>1</button>
        <button class="btn btn-primary PresetButton" value=2>2</button>
        <button class="btn btn-primary PresetButton" value=3>3</button>
        <button class="btn btn-primary PresetButton" value=4>4</button>
        <button class="btn btn-secondary" id="resetButton">초기화</button>
        <button class="help-btn">?</button>
        <div class="description-box"><Strong>이 화면에서는 사용자가 원하는 동작을 설정할 수 있는 화면이에요.<br>
            <br>· 1234: 번호마다 원하는 몸동작, 손동작을 넣을 수 있어요.
            <br>· 초기화: 이 버튼을 누르면 처음 설정으로 돌아가요.
            <br>· 손동작 모드/ 몸동작 모드: 이 버튼은 손동작과 몸동작을 선택할 수 있어요.
            <br>· 녹화하기/삭제하기: 동작마다 소리를 다르게 저장할 수 있어요/ 원래 있던 동작을 없앨 수 있어요.</Strong>
        </div>
    </div>

    <div class="container mt-3">
        <table class="table">
            <thead>
                <tr>
                    <th>계이름</th>
                    <th>포즈 설명</th>
                    <th>촬영</th>
                    <th>삭제</th>
                </tr>
            </thead>
            <tbody>
                {% for idx, name in name_codes.items() %}
                <tr data-idx="{{ idx }}">
                    <td>{{ name }}</td>
                    {% if image_status[idx] == True %}
                    <td>
                        {% if mode == "gesture" %}
                        <img id="gesture_capture_{{ idx }}" src="{{ url_for('static', filename = '/capture/gesture/' + gesture_preset + '/capture_gesture_'+code[idx]+'.jpg') }}?timestamp={{ timestamp[idx] }}" width="320" height="200">
                        {% else %}
                        <img id="pose_capture_{{ idx }}" src="{{ url_for('static', filename = '/capture/pose/' + pose_preset + '/capture_pose_'+code[idx]+'.jpg') }}?timestamp={{ timestamp[idx] }}" width="320" height="200">
                        {% endif %}
                    </td>
                    {% else %}
                    <td></td>
                    {% endif %}
                    <td>
                        <button class="LiveButton" value="{{ idx }}">녹화하기</button>
                    </td>
                    <td>
                        <button class="DeleteButton" value="{{ idx }}">삭제하기</button>
                    </td>
                    <td>
                        <div id="myDiv{{ idx }}" style="display: none;">
                            <img id="video_gesture{{ idx }}" src="" /> <br>
                            <img id="video_pose{{ idx }}" src=""/> <br>
                            <button class="stopButton" value="True">녹화 중지하기</button>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    <script>
        var currentMode;

        function updateButtonColors(preset) {
            const buttons = document.querySelectorAll('.PresetButton');
            buttons.forEach(button => {
                button.classList.remove('btn-success');
                button.classList.add('btn-primary');
            });
            const activeButton = document.querySelector('.PresetButton[value="' + preset + '"]');
            if (activeButton) {
                activeButton.classList.remove('btn-primary');
                activeButton.classList.add('btn-success');
            }
        }

        document.addEventListener('DOMContentLoaded', function () {
            const gestureModeButton = document.getElementById('GestureModeButton');
            const poseModeButton = document.getElementById('PoseModeButton');
            gesturePreset = document.body.getAttribute('data-gesture-preset');
            posePreset = document.body.getAttribute('data-pose-preset');
            currentMode = document.body.getAttribute('current-mode'); 


            gestureModeButton.addEventListener('click', function () {
                document.getElementById('GestureModeButton').classList.add('btn-primary');
                document.getElementById('GestureModeButton').classList.remove('btn-secondary');

                document.getElementById('PoseModeButton').classList.add('btn-secondary');
                document.getElementById('PoseModeButton').classList.remove('btn-primary');

                currentMode = 'gesture';
                updateButtonColors(gesturePreset);
                $.ajax({
                    url: "/Get_AllMovements",
                    type: "POST",
                    data: { mode: currentMode },
                    success: function (response) {
                        console.log("성공:", response);
                        updatePage(response);
                    },
                    error: function (error) {
                        console.log("오류:", error);
                    }
                });
            });

            poseModeButton.addEventListener('click', function () {
                document.getElementById('PoseModeButton').classList.add('btn-primary');
                document.getElementById('PoseModeButton').classList.remove('btn-secondary');

                document.getElementById('GestureModeButton').classList.add('btn-secondary');
                document.getElementById('GestureModeButton').classList.remove('btn-primary');

                currentMode = 'pose';
                updateButtonColors(posePreset);
                $.ajax({
                    url: "/Get_AllMovements",
                    type: "POST",
                    data: { mode: currentMode },
                    success: function (response) {
                        console.log("성공:", response);
                        updatePage(response);
                    },
                    error: function (error) {
                        console.log("오류:", error);
                    }
                });
            });

            // 페이지 로드 시 기본 프리셋 버튼 색상 업데이트
            updateButtonColors(currentMode === 'gesture' ? gesturePreset : posePreset);

            // 버튼 클릭 이벤트 설정
            $('.PresetButton').click(function () {
                var buttonValue = $(this).val();
                if (currentMode === 'gesture') {
                    gesturePreset = buttonValue;
                } else if (currentMode === 'pose') {
                    posePreset = buttonValue;
                }
                updateButtonColors(buttonValue);

                $.ajax({
                    url: "/Get_AllMovements",
                    type: "POST",
                    data: { preset: buttonValue, mode: currentMode },
                    success: function (response) {
                        console.log("성공:", response);
                        updatePage(response);
                    },
                    error: function (error) {
                        console.log("오류:", error);
                    }
                });
            });

            $('.LiveButton').click(function () {
                var buttonValue = $(this).val();
                $.ajax({
                    url: "/Get_AllMovements",
                    type: "POST",
                    data: { button_value: buttonValue, mode: currentMode },
                    success: function (response) {
                        console.log("성공:", response);
                        toggleDivVisibility(buttonValue);
                    },
                    error: function (error) {
                        console.log("오류:", error);
                    }
                });
            });

            $('.DeleteButton').click(function () {
                var buttonValue = $(this).val();
                $.ajax({
                    url: "/Get_AllMovements",
                    type: "POST",
                    data: { delete_button_value: buttonValue, mode: currentMode },
                    success: function (response) {
                        console.log("성공:", response);
                        updatePage(response);
                    },
                    error: function (error) {
                        console.log("오류:", error);
                    }
                });
            });

            $('.stopButton').click(function () {
                var stopSign = $(this).val();
                $.ajax({
                    url: "/Get_AllMovements",
                    type: "POST",
                    data: { stop_sign: stopSign, mode: currentMode },
                    success: function (response) {
                        console.log("성공:", response);
                        divClear();
                        updatePage(response);
                    },
                    error: function (error) {
                        console.log("오류:", error);
                    }
                });
            });

            $('#resetButton').click(function () {
                currentMode = "gesture";
                gesturePreset = '1';
                posePreset = '1';
                $('#GestureModeButton').addClass('btn-primary').removeClass('btn-secondary');
                $('#PoseModeButton').addClass('btn-secondary').removeClass('btn-primary');
                updateButtonColors(gesturePreset);
                $.ajax({
                    url: "/reset",
                    type: "POST",
                    data: { mode: currentMode },
                    success: function (response) {
                        console.log("성공:", response);
                        updatePage(response);
                    },
                    error: function (error) {
                        console.log("오류:", error);
                    }
                });
            });
        });

        function updatePage(response) {
            if (!response.data) {
                console.error('Invalid response data');
                return;
            }
            response.data.forEach(function (item) {
                const row = document.querySelector(`tr[data-idx="${item.idx}"]`);
                const imgCell = row.querySelector('td:nth-child(2)');
                if (item.image_status) {
                    imgCell.innerHTML = currentMode === 'gesture' ? 
                        `<img id="gesture_capture_${item.idx}" src="${item.image_url}?timestamp=${item.timestamp}" width="320" height="200">` : 
                        `<img id="pose_capture_${item.idx}" src="${item.image_url}?timestamp=${item.timestamp}" width="320" height="200">`;
                } else {
                    imgCell.innerHTML = ``;
                }
            });
            // 이벤트 리스너를 다시 설정합니다.
            setEventListeners();
        }

        function setEventListeners() {
            $('.LiveButton').off('click').on('click', function () {
                var buttonValue = $(this).val();
                $.ajax({
                    url: "/Get_AllMovements",
                    type: "POST",
                    data: { button_value: buttonValue, mode: currentMode },
                    success: function (response) {
                        console.log("성공:", response);
                        updatePage(response);
                        toggleDivVisibility(buttonValue);
                    },
                    error: function (error) {
                        console.log("오류:", error);
                    }
                });
            });

            $('.DeleteButton').off('click').on('click', function () {
                var buttonValue = $(this).val();
                $.ajax({
                    url: "/Get_AllMovements",
                    type: "POST",
                    data: { delete_button_value: buttonValue, mode: currentMode },
                    success: function (response) {
                        console.log("성공:", response);
                        updatePage(response);
                    },
                    error: function (error) {
                        console.log("오류:", error);
                    }
                });
            });

            $('.stopButton').off('click').on('click', function () {
                var stopSign = $(this).val();
                $.ajax({
                    url: "/Get_AllMovements",
                    type: "POST",
                    data: { stop_sign: stopSign, mode: currentMode },
                    success: function (response) {
                        console.log("성공:", response);
                        updatePage(response);
                        divClear();
                    },
                    error: function (error) {
                        console.log("오류:", error);
                    }
                });
            });
        }

        function toggleDivVisibility(buttonValue) {
            // 모든 버튼의 영상을 숨깁니다.
            $('[id^="video_gesture"], [id^="video_pose"]').attr('src', '');

            // 현재 클릭한 버튼에 해당하는 영상만 보여줍니다.
            var videoId = currentMode === "gesture" ? "#video_gesture" : "#video_pose";
            var videoSrc = currentMode === "gesture" ? "/get_video_gesture" : "/get_video_pose";
            $(videoId + buttonValue).attr('src', videoSrc).show();

            // 모든 버튼 영역을 숨깁니다.
            $('[id^="myDiv"]').hide().removeClass('fixedStreaming');

            // 현재 클릭한 버튼에 해당하는 영역만 보여줍니다.
            var showDiv = $('#myDiv' + buttonValue).show();
            showDiv.show().addClass('fixedStreaming');
        }

        function divClear() {
            // 모든 버튼의 영상을 숨깁니다.
            $('[id^="video_gesture"], [id^="video_pose"]').attr('src', '');
            
            // 모든 버튼 영역을 숨깁니다.
            $('[id^="myDiv"]').hide().removeClass('fixedStreaming');
        }

        $(document).ready(function() {
            $(".help-btn").click(function() {
                // 현재 클릭한 버튼에 해당하는 설명 박스만 찾아서 처리
                var $descriptionBox = $(this).next(".description-box");

                // 버튼의 위치와 크기를 가져옴
                var offset = $(this).offset();
                var height = $(this).outerHeight();

                $descriptionBox.css({
                    top: offset.top + height + "px", // "px" 단위 추가
                    left: offset.left + "px" // "px" 단위 추가
                }).toggle();
            });
        })
    </script>
</body>
</html>